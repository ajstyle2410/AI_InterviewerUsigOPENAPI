<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Interviewer (OpenAI)</title>
  <style>
    :root { color-scheme: light dark; font-family: "Inter", system-ui, sans-serif; }
    body { margin: 0; background: #0f172a; color: #e2e8f0; }
    header { padding: 24px 32px; background: #111827; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #1f2937; }
    main { padding: 24px 32px 48px; max-width: 1200px; margin: 0 auto; }
    .grid { display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1.2fr); gap: 24px; }
    .column { display: flex; flex-direction: column; gap: 24px; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 12px; padding: 20px; box-shadow: 0 12px 24px rgba(15, 23, 42, 0.4); }
    label { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.08em; color: #94a3b8; }
    select, textarea, input, button { width: 100%; margin-top: 8px; border-radius: 8px; border: 1px solid #334155; padding: 10px 12px; background: #0f172a; color: #e2e8f0; font-size: 0.95rem; box-sizing: border-box; }
    textarea { min-height: 100px; resize: vertical; }
    button { cursor: pointer; background: #2563eb; border: none; font-weight: 600; }
    .secondary { background: #1f2937; }
    .row { display: flex; gap: 12px; margin-top: 12px; }
    .row button { flex: 1; }
    .messages { max-height: 520px; overflow-y: auto; display: flex; flex-direction: column; gap: 14px; margin-top: 12px; }
    .bubble { padding: 12px 14px; border-radius: 12px; line-height: 1.5; background: #1e293b; border: 1px solid #334155; }
    .bubble.user { align-self: flex-end; background: #2563eb; border-color: #3b82f6; }
    .badge { font-size: 0.75rem; color: #94a3b8; }
    .status { margin-top: 12px; font-size: 0.85rem; color: #cbd5f5; }
    .pill { display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; border-radius: 999px; border: 1px solid #334155; background: #0f172a; font-size: 0.85rem; margin-top: 8px; }
    .question-list { display: flex; flex-direction: column; gap: 10px; margin-top: 12px; }
    .question-item { padding: 10px 12px; border-radius: 10px; border: 1px solid #334155; background: #0f172a; display: grid; gap: 8px; }
    .virtual-room { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-top: 12px; }
    .tile { background: #0f172a; border: 1px solid #334155; border-radius: 12px; padding: 16px; min-height: 120px; display: flex; flex-direction: column; justify-content: space-between; }
    .tile span { font-size: 0.8rem; color: #94a3b8; }
    .score { font-size: 2.2rem; font-weight: 700; color: #38bdf8; }
    ul { margin: 8px 0 0 18px; color: #cbd5f5; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<header>
  <div><h1>AI Interviewer</h1><p class="badge">Role-play + pronunciation + grammar practice</p></div>
  <div class="badge">OpenAI API + Speech tools</div>
</header>
<main>
  <div class="grid">
    <div class="column">
      <section class="card">
        <h2>Interview setup</h2>
        <label for="mode">Interview mode</label>
        <select id="mode"><option value="TECHNICAL">Technical</option><option value="HR">HR</option><option value="MANAGER">Manager</option></select>
        <label for="scenario">Practice scenario</label>
        <select id="scenario"><option value="">Open interview</option><option value="Mock intro + follow-up">Mock intro + follow-up</option><option value="Hiring manager role-play">Hiring manager role-play</option><option value="Behavioral STAR role-play">Behavioral STAR role-play</option></select>
        <label for="goal">Session goal</label>
        <input id="goal" maxlength="200" placeholder="E.g., concise answers and stronger confidence" />
        <label for="tone">Coach tone</label>
        <select id="tone"><option value="">Standard</option><option value="Supportive and encouraging">Supportive and encouraging</option><option value="Direct and concise">Direct and concise</option><option value="Challenging and probing">Challenging and probing</option></select>
        <label for="experience">Experience level</label>
        <select id="experience"><option value="FRESHER">Fresher</option><option value="EXPERIENCED">Experienced</option></select>
        <label for="prompt">Your answer or question</label>
        <textarea id="prompt" maxlength="1000" placeholder="Type or use the mic..."></textarea>
        <div class="badge" id="promptCount">0 / 1000</div>
        <div class="pill"><input type="checkbox" id="questionOnly" /><label for="questionOnly" style="text-transform:none; letter-spacing:0; margin:0;">Question-only interviewer</label></div>
        <div class="pill"><input type="checkbox" id="autoPlay" /><label for="autoPlay" style="text-transform:none; letter-spacing:0; margin:0;">Auto-play reply</label></div>
        <label for="timer">Practice timer (minutes)</label>
        <div class="row"><input id="timer" type="number" min="1" max="10" value="2" /><button id="timerStart" class="secondary">Start</button><button id="timerStop" class="secondary">Stop</button></div>
        <div class="badge" id="timerStatus">Timer ready.</div>
        <div class="row"><button id="send">Send</button><button id="mic" class="secondary">Start mic</button></div>
        <div class="row"><button id="play" class="secondary">Play answer (TTS)</button><button id="clear" class="secondary">Clear</button></div>
        <p class="status" id="status">Ready.</p>
      </section>

      <section class="card">
        <h2>Role-play starter</h2>
        <label for="interviewerRole">Interviewer role</label>
        <input id="interviewerRole" maxlength="120" value="Senior Engineering Manager" />
        <label for="companyContext">Company context</label>
        <input id="companyContext" maxlength="200" placeholder="E.g., SaaS startup scaling globally" />
        <div class="row"><button id="startRolePlay">Start role-play</button></div>
        <div class="status" id="rolePlayOpening">Waiting to start role-play.</div>
      </section>

      <section class="card">
        <h2>Pronunciation guide & practice</h2>
        <label for="pronunciationText">Word or sentence</label>
        <input id="pronunciationText" maxlength="300" placeholder="E.g., scalability, stakeholder communication" />
        <div class="row"><button id="getPronunciation">Get guide</button><button id="practicePronunciation" class="secondary">Practice sentence to chat</button></div>
        <div class="status" id="pronIpa"></div>
        <div class="badge">Syllables</div><ul id="pronSyllables"></ul>
        <div class="badge">Tips</div><ul id="pronTips"></ul>
        <div class="badge">Practice sentences</div><ul id="pronSentences"></ul>
      </section>

      <section class="card">
        <h2>Grammar correction</h2>
        <label for="grammarInput">Answer text</label>
        <textarea id="grammarInput" maxlength="2000" placeholder="Paste your answer for quick grammar correction"></textarea>
        <div class="row"><button id="fixGrammar">Correct grammar</button><button id="useLastForGrammar" class="secondary">Use last answer</button></div>
        <div class="status" id="grammarCorrected"></div>
        <div class="badge">Issues</div><ul id="grammarIssues"></ul>
      </section>
    </div>

    <div class="column">
      <section class="card">
        <h2>Conversation</h2>
        <div class="messages" id="messages"></div>
        <audio id="tts" controls style="width: 100%; margin-top: 16px; display: none;"></audio>
      </section>

      <section class="card">
        <h2>Answer evaluation</h2>
        <label for="question">Interview question</label>
        <input id="question" placeholder="Paste question" maxlength="800" />
        <label for="answer">Your answer</label>
        <textarea id="answer" maxlength="2000" placeholder="Paste answer"></textarea>
        <div class="badge" id="answerCount">0 / 2000</div>
        <div class="row"><button id="evaluate">Evaluate answer</button><button id="useLast" class="secondary">Use last answer</button></div>
        <div class="row"><div><div class="badge">Score</div><div class="score" id="score">--</div></div><div style="flex:1;"><div class="badge">Feedback</div><div id="feedback" class="badge">Awaiting evaluation.</div></div></div>
        <div class="status" id="corrected"></div>
      </section>

      <section class="card">
        <h2>Top questions</h2>
        <label for="search">Search top-ranked questions</label>
        <input id="search" placeholder="Keyword" />
        <div class="row"><button id="searchBtn" class="secondary">Search</button><button id="refreshBtn" class="secondary">Refresh</button></div>
        <div class="question-list" id="questionList"></div>
      </section>

      <section class="card">
        <h2>Virtual interview room</h2>
        <p class="badge">Teams-style live view</p>
        <div class="virtual-room">
          <div class="tile"><strong>Interviewer</strong><span>Audio: Live</span><span>Camera: On</span></div>
          <div class="tile"><strong>You (Candidate)</strong><span>Audio: Live</span><span>Camera: Off</span></div>
          <div class="tile"><strong>Notes</strong><span id="roomNotes">Use STAR and quantify impact.</span></div>
        </div>
        <div class="row"><button id="join" class="secondary">Join call</button><button id="rules" class="secondary">Show restrictions</button></div>
        <div class="status" id="restrictionStatus"></div>
      </section>
    </div>
  </div>
</main>

<script>
  const promptEl = document.getElementById('prompt');
  const modeEl = document.getElementById('mode');
  const scenarioEl = document.getElementById('scenario');
  const goalEl = document.getElementById('goal');
  const toneEl = document.getElementById('tone');
  const experienceEl = document.getElementById('experience');
  const messagesEl = document.getElementById('messages');
  const statusEl = document.getElementById('status');
  const ttsEl = document.getElementById('tts');
  const questionOnlyEl = document.getElementById('questionOnly');
  const autoPlayEl = document.getElementById('autoPlay');
  const timerEl = document.getElementById('timer');
  const timerStatusEl = document.getElementById('timerStatus');
  const questionEl = document.getElementById('question');
  const answerEl = document.getElementById('answer');
  const scoreEl = document.getElementById('score');
  const feedbackEl = document.getElementById('feedback');
  const correctedEl = document.getElementById('corrected');
  const promptCountEl = document.getElementById('promptCount');
  const answerCountEl = document.getElementById('answerCount');
  const searchEl = document.getElementById('search');
  const questionListEl = document.getElementById('questionList');
  const restrictionStatusEl = document.getElementById('restrictionStatus');

  const rolePlayOpeningEl = document.getElementById('rolePlayOpening');
  const interviewerRoleEl = document.getElementById('interviewerRole');
  const companyContextEl = document.getElementById('companyContext');
  const pronunciationTextEl = document.getElementById('pronunciationText');
  const pronIpaEl = document.getElementById('pronIpa');
  const pronSyllablesEl = document.getElementById('pronSyllables');
  const pronTipsEl = document.getElementById('pronTips');
  const pronSentencesEl = document.getElementById('pronSentences');
  const grammarInputEl = document.getElementById('grammarInput');
  const grammarCorrectedEl = document.getElementById('grammarCorrected');
  const grammarIssuesEl = document.getElementById('grammarIssues');

  const history = [];
  let recognition; let lastAssistantReply = ''; let lastUserAnswer = '';
  let timerInterval; let remainingSeconds = 0;

  function addMessage(role, content) {
    const bubble = document.createElement('div'); bubble.className = `bubble ${role}`; bubble.textContent = content;
    messagesEl.appendChild(bubble); messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function renderList(el, items) {
    el.innerHTML = ''; (items || []).forEach(item => { const li = document.createElement('li'); li.textContent = item; el.appendChild(li); });
  }

  function updateCounters() { promptCountEl.textContent = `${promptEl.value.length} / 1000`; answerCountEl.textContent = `${answerEl.value.length} / 2000`; }

  async function sendPrompt() {
    const prompt = promptEl.value.trim(); if (!prompt) return;
    addMessage('user', prompt); history.push({ role: 'user', content: prompt }); lastUserAnswer = prompt; promptEl.value = '';
    const response = await fetch('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({
      prompt, mode: modeEl.value, experience: experienceEl.value, history, questionOnly: questionOnlyEl.checked,
      scenario: scenarioEl.value, goal: goalEl.value, tone: toneEl.value
    })});
    if (!response.ok) { statusEl.textContent = 'Request failed.'; return; }
    const data = await response.json(); lastAssistantReply = data.reply; history.push({ role: 'assistant', content: data.reply }); addMessage('assistant', data.reply);
    if (data.reply.trim().endsWith('?')) questionEl.value = data.reply.trim();
    if (autoPlayEl.checked) await playReply();
    statusEl.textContent = 'Ready.';
  }

  function setupMic() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) { statusEl.textContent = 'Speech recognition not supported.'; return; }
    recognition = new SpeechRecognition(); recognition.lang = 'en-US'; recognition.interimResults = true;
    recognition.onresult = (event) => { promptEl.value = Array.from(event.results).map(r => r[0].transcript).join(''); updateCounters(); };
    recognition.onstart = () => { statusEl.textContent = 'Listening...'; };
    recognition.onend = () => { statusEl.textContent = 'Mic stopped.'; };
  }

  async function playReply() {
    if (!lastAssistantReply) return;
    const response = await fetch('/api/speech/speak', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ text: lastAssistantReply }) });
    if (!response.ok) return;
    const blob = await response.blob(); ttsEl.src = URL.createObjectURL(blob); ttsEl.style.display = 'block'; await ttsEl.play();
  }

  async function evaluateAnswer() {
    const question = questionEl.value.trim(); const answer = answerEl.value.trim(); if (!question || !answer) return;
    const response = await fetch('/api/evaluate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question, answer, mode: modeEl.value, experience: experienceEl.value }) });
    if (!response.ok) { feedbackEl.textContent = 'Evaluation failed.'; return; }
    const data = await response.json(); scoreEl.textContent = `${data.scorePercent}%`;
    feedbackEl.textContent = `Grammar: ${data.grammarIssues?.join('; ') || 'None'} | Improvements: ${data.improvements?.join('; ') || 'None'}`;
    correctedEl.textContent = data.correctedAnswer ? `Suggested correction: ${data.correctedAnswer}` : '';
  }

  async function loadQuestions() {
    const params = new URLSearchParams({ mode: modeEl.value, experience: experienceEl.value, q: searchEl.value || '', limit: '5' });
    const response = await fetch(`/api/questions?${params.toString()}`); if (!response.ok) return;
    const data = await response.json(); questionListEl.innerHTML = '';
    data.forEach(item => {
      const card = document.createElement('div'); card.className = 'question-item';
      card.innerHTML = `<strong>${item.question}</strong><span class="badge">Rank: ${item.rank}</span><button class="secondary">Ask this</button>`;
      card.querySelector('button').addEventListener('click', () => { questionEl.value = item.question; promptEl.value = item.question; updateCounters(); });
      questionListEl.appendChild(card);
    });
  }

  async function startRolePlay() {
    const response = await fetch('/api/coach/roleplay/start', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({
      mode: modeEl.value, experience: experienceEl.value, interviewerRole: interviewerRoleEl.value, companyContext: companyContextEl.value, candidateGoal: goalEl.value
    })});
    if (!response.ok) { rolePlayOpeningEl.textContent = 'Role-play start failed.'; return; }
    const data = await response.json(); rolePlayOpeningEl.textContent = `${data.opening} (Focus: ${data.expectedFocus})`;
    promptEl.value = data.opening; updateCounters();
  }

  async function getPronunciation() {
    const text = pronunciationTextEl.value.trim(); if (!text) return;
    const response = await fetch('/api/coach/pronunciation', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text }) });
    if (!response.ok) return;
    const data = await response.json(); pronIpaEl.textContent = data.ipa ? `IPA: ${data.ipa}` : '';
    renderList(pronSyllablesEl, data.syllableBreakdown); renderList(pronTipsEl, data.practiceTips); renderList(pronSentencesEl, data.practiceSentences);
  }

  async function fixGrammar() {
    const answer = grammarInputEl.value.trim(); if (!answer) return;
    const response = await fetch('/api/coach/grammar', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ answer }) });
    if (!response.ok) return;
    const data = await response.json(); grammarCorrectedEl.textContent = `Corrected: ${data.corrected || ''}`; renderList(grammarIssuesEl, data.issues);
  }

  function startTimer() {
    const minutes = Math.min(Math.max(parseInt(timerEl.value || '2', 10), 1), 10); remainingSeconds = minutes * 60;
    clearInterval(timerInterval); timerStatusEl.textContent = `Timer running: ${minutes}:00`;
    timerInterval = setInterval(() => {
      remainingSeconds -= 1; const mins = Math.floor(remainingSeconds / 60); const secs = remainingSeconds % 60;
      timerStatusEl.textContent = `Timer running: ${mins}:${secs.toString().padStart(2, '0')}`;
      if (remainingSeconds <= 0) { clearInterval(timerInterval); timerStatusEl.textContent = 'Timer done. Wrap up your answer.'; }
    }, 1000);
  }

  document.getElementById('send').addEventListener('click', sendPrompt);
  document.getElementById('mic').addEventListener('click', () => { if (!recognition) setupMic(); if (recognition) recognition.start(); });
  document.getElementById('play').addEventListener('click', playReply);
  document.getElementById('clear').addEventListener('click', () => { messagesEl.innerHTML = ''; history.length = 0; lastAssistantReply = ''; lastUserAnswer = ''; ttsEl.style.display = 'none'; });
  document.getElementById('evaluate').addEventListener('click', evaluateAnswer);
  document.getElementById('useLast').addEventListener('click', () => { answerEl.value = lastUserAnswer; updateCounters(); });
  document.getElementById('searchBtn').addEventListener('click', loadQuestions);
  document.getElementById('refreshBtn').addEventListener('click', () => { searchEl.value = ''; loadQuestions(); });
  document.getElementById('join').addEventListener('click', () => { restrictionStatusEl.textContent = 'Call joined. Keep answers concise.'; });
  document.getElementById('rules').addEventListener('click', () => { restrictionStatusEl.textContent = 'Restrictions: max 1000 chars per message, one question at a time.'; });
  document.getElementById('timerStart').addEventListener('click', startTimer);
  document.getElementById('timerStop').addEventListener('click', () => { clearInterval(timerInterval); timerStatusEl.textContent = 'Timer stopped.'; });
  document.getElementById('startRolePlay').addEventListener('click', startRolePlay);
  document.getElementById('getPronunciation').addEventListener('click', getPronunciation);
  document.getElementById('practicePronunciation').addEventListener('click', () => {
    const firstSentence = pronSentencesEl.querySelector('li')?.textContent; if (firstSentence) { promptEl.value = firstSentence; updateCounters(); }
  });
  document.getElementById('fixGrammar').addEventListener('click', fixGrammar);
  document.getElementById('useLastForGrammar').addEventListener('click', () => { grammarInputEl.value = lastUserAnswer; });

  promptEl.addEventListener('input', updateCounters); answerEl.addEventListener('input', updateCounters);
  modeEl.addEventListener('change', loadQuestions); experienceEl.addEventListener('change', loadQuestions);
  updateCounters(); loadQuestions();
</script>
</body>
</html>
